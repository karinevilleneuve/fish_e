<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Taxonomy cross validation by identity (TAXXI) | Fish-eDNA.knit</title>
  <meta name="description" content="Prospect of eDNA for freshwater fishes from Alberta" />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="Taxonomy cross validation by identity (TAXXI) | Fish-eDNA.knit" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="Prospect of eDNA for freshwater fishes from Alberta" />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Taxonomy cross validation by identity (TAXXI) | Fish-eDNA.knit" />
  
  <meta name="twitter:description" content="Prospect of eDNA for freshwater fishes from Alberta" />
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="index.html"/>
<link rel="next" href="required-files-scripts-and-programs.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.33/datatables.js"></script>
<link href="libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Our dataset</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#alberta-fishes"><i class="fa fa-check"></i>Alberta fishes</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#methods-and-their-associated-available-databases"><i class="fa fa-check"></i>Methods and their associated available databases</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#representation-of-alberta-freshwater-fishes-in-databases"><i class="fa fa-check"></i>Representation of Alberta freshwater fishes in databases</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html"><i class="fa fa-check"></i>Taxonomy cross validation by identity (TAXXI)</a>
<ul>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#generate-benchmark-datasets"><i class="fa fa-check"></i>Generate benchmark datasets</a></li>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#generate-predictions-for-rdp-classifier"><i class="fa fa-check"></i>Generate predictions for RDP Classifier</a>
<ul>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#required-files"><i class="fa fa-check"></i>Required files</a></li>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#generate-required-files"><i class="fa fa-check"></i>Generate required files</a></li>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#train-the-set"><i class="fa fa-check"></i>Train the set</a></li>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#generate-predictions"><i class="fa fa-check"></i>Generate predictions</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#generate-predictions-for-vsearch"><i class="fa fa-check"></i>Generate predictions for VSEARCH</a></li>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cvi-metrics"><i class="fa fa-check"></i>CVI metrics</a>
<ul>
<li class="chapter" data-level="" data-path="taxonomy-cross-validation-by-identity-taxxi.html"><a href="taxonomy-cross-validation-by-identity-taxxi.html#script-to-evaluate-prediction"><i class="fa fa-check"></i>Script to evaluate prediction</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="required-files-scripts-and-programs.html"><a href="required-files-scripts-and-programs.html"><i class="fa fa-check"></i>Required files, scripts and programs</a>
<ul>
<li class="chapter" data-level="" data-path="required-files-scripts-and-programs.html"><a href="required-files-scripts-and-programs.html#programs"><i class="fa fa-check"></i>Programs</a></li>
<li class="chapter" data-level="" data-path="required-files-scripts-and-programs.html"><a href="required-files-scripts-and-programs.html#databases"><i class="fa fa-check"></i>Databases</a></li>
<li class="chapter" data-level="" data-path="required-files-scripts-and-programs.html"><a href="required-files-scripts-and-programs.html#scripts"><i class="fa fa-check"></i>Scripts</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="code.html"><a href="code.html"><i class="fa fa-check"></i>Code</a>
<ul>
<li class="chapter" data-level="" data-path="code.html"><a href="code.html#evaluating-representation-in-databases"><i class="fa fa-check"></i>Evaluating representation in databases</a></li>
<li class="chapter" data-level="" data-path="code.html"><a href="code.html#workflows"><i class="fa fa-check"></i>Workflows</a>
<ul>
<li class="chapter" data-level="" data-path="code.html"><a href="code.html#dada2"><i class="fa fa-check"></i>DADA2</a></li>
<li class="chapter" data-level="" data-path="code.html"><a href="code.html#barque"><i class="fa fa-check"></i>Barque</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="code.html"><a href="code.html#curating-databases"><i class="fa fa-check"></i>Curating databases</a></li>
<li class="chapter" data-level="0.1" data-path="code.html"><a href="code.html#curating-databases-for-distance-matrix"><i class="fa fa-check"></i><b>0.1</b> Curating databases for distance matrix</a>
<ul>
<li class="chapter" data-level="0.1.1" data-path="code.html"><a href="code.html#barque-1"><i class="fa fa-check"></i><b>0.1.1</b> Barque</a></li>
<li class="chapter" data-level="0.1.2" data-path="code.html"><a href="code.html#rdp"><i class="fa fa-check"></i><b>0.1.2</b> RDP</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="code.html"><a href="code.html#comparing-pipelines-with-available-databases"><i class="fa fa-check"></i>Comparing pipelines with available databases</a>
<ul>
<li class="chapter" data-level="" data-path="code.html"><a href="code.html#dada2-1"><i class="fa fa-check"></i>DADA2</a></li>
<li class="chapter" data-level="" data-path="code.html"><a href="code.html#barque-2"><i class="fa fa-check"></i>Barque</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="code.html"><a href="code.html#curating-databases-1"><i class="fa fa-check"></i>Curating databases</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="supplementary-data.html"><a href="supplementary-data.html"><i class="fa fa-check"></i>Supplementary data</a>
<ul>
<li class="chapter" data-level="" data-path="supplementary-data.html"><a href="supplementary-data.html#installing-the-rdp-classifier"><i class="fa fa-check"></i>Installing the RDP classifier</a></li>
</ul></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="taxonomy-cross-validation-by-identity-taxxi" class="section level1 unnumbered hasAnchor">
<h1>Taxonomy cross validation by identity (TAXXI)<a href="taxonomy-cross-validation-by-identity-taxxi.html#taxonomy-cross-validation-by-identity-taxxi" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Framework developed by Edgard (2018). Link to <a href="https://peerj.com/articles/4652/">article</a> and <a href="https://drive5.com/taxxi/doc/index.html">TAXXI website</a>.</p>
<p>Cross-validation by identity (CVI) models varying distances between query sequences and reference sequences. A reference with known taxonomies is split into test and training sets such that for all test sequences, the most similar training sequence has a given identity (<em>d</em>). This is repeated for different identities, enabling assessment of prediction accuracy at varying distances from the reference.</p>
<p><img style="padding:30px" src="data/taxxi_figures.jpg" align="left" width="20%"/></p>
<p><br />
- <em>R</em> is the reference dataset divided into four disjoint subsets <em>S</em>, <em>T</em>, <em>W</em> and <em>Z</em>.<br />
- <em>S</em> is the <strong>test set</strong>.<br />
- <em>A</em> is the <strong>training set</strong> formed by the union of <em>T</em> and <em>W</em>.<br />
- <em>T</em> is the set of top hits for sequences in <em>S</em>, which are constrained to have identities in the range <em>d</em> ± σ<br />
(where σ specifies the maximum allowed deviation from the desired identity (<em>d</em>)).<br />
- <em>W</em> contains reference sequences with identity &lt; <em>d</em>; these are retained to create the largest possible training set.<br />
- <em>Z</em> contains sequences which cannot be assigned to <em>S</em>, <em>T</em> or <em>W</em> without violating the identity constraint.</p>
<p><br clear="left"/></p>
<div id="generate-benchmark-datasets" class="section level2 unnumbered hasAnchor">
<h2>Generate benchmark datasets<a href="taxonomy-cross-validation-by-identity-taxxi.html#generate-benchmark-datasets" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The <code>distmx_split_identity</code> command from <a href="https://www.drive5.com/usearch/manual/cvi.html">USEARCH</a> divides sequences into subsets such that the top-hit identity is a given value. This is used to create test-training pairs for cross-validation by identity. Input is a distance matrix created by the <code>calc_distmx command</code>. As per the methods specified in Edgar (2018) maximum allowed deviation (σ) from <em>d</em> used : σ = 1% for <em>d</em> = 90% and σ = 0.5% for <em>d</em> = 99, 97 and 95%. The following code was adapted from <a href="https://doi.org/10.1016/j.ecoinf.2024.102817">Donhauser <em>et al.</em> (2024)</a> and validated with available documentation from <a href="https://www.drive5.com/usearch/manual/cvi.html">USEARCH</a>.</p>
<p>Testing with available databases (barque COI <a href="https://www.ibis.ulaval.ca/services/bioinformatique/barque_databases/">3</a>, RDP COI V5.1.0 <a href="https://github.com/terrimporter/CO1Classifier/releases/tag/RDP-COI-v5.1.0">5</a>, RDP 12S <a href="https://github.com/terrimporter/12SfishClassifier/releases/tag/v1.0.1">10</a> and barque 12S <a href="https://github.com/enormandeau/barque/blob/master/03_databases/12S.fasta.gz">11</a>))</p>
<p>Remove tab spaces in sequence name (for RDP databases specifically).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb1-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.fasta <span class="kw">;</span> <span class="cf">do</span> <span class="fu">sed</span> <span class="at">-i</span> <span class="st">&#39;s/\t/;/g&#39;</span> <span class="va">$i</span> <span class="kw">;</span> <span class="cf">done</span> </span></code></pre></div>
<ul>
<li>Before : <code>&gt;NC_003178      cellularOrganisms;Eukaryota;Metazoa;Chordata;Actinopteri;Ateleopodiformes;Ateleopodidae;Ateleopus;Ateleopus_japonicus</code></li>
<li>After : <code>&gt;NC_003178;cellularOrganisms;Eukaryota;Metazoa;Chordata;Actinopteri;Ateleopodiformes;Ateleopodidae;Ateleopus;Ateleopus_japonicus</code></li>
</ul>
<p>All the sequences from the COI used with RDP were lowercase. The following code was used to make them uppercase :</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb2-1" tabindex="-1"></a><span class="ex">seqkit</span> seq mytrainseq.fasta <span class="at">--upper-case</span> <span class="at">-w</span> 0 <span class="op">&gt;</span> rdp_coi.fasta</span></code></pre></div>
<p>Create a distance matrix using function <code>-calc_distmx</code></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb3-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.fasta <span class="kw">;</span> <span class="cf">do</span> <span class="ex">~/usearch</span> <span class="at">-calc_distmx</span> <span class="va">$i</span> <span class="at">-maxdist</span> 0.2 <span class="at">-termdist</span> 0.3 <span class="at">-tabbedout</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>_distmax.txt<span class="kw">;</span> <span class="cf">done</span></span></code></pre></div>
<p>Considering the size of the original COI databases, the memory limit of of 32-bit process was exceeded, and therefore the 64-bit build was required. To overcome this issue I filtered out non-fish sequence from the database. The code used can be found <a href="code.html#curating-databases-for-distance-matrix">here</a>.</p>
<p>To create training and test datasets at different identity thresholds the following code was executed from a bash script called <code>run_splitid.sh</code> using nohup.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb4-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.fasta <span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb4-2"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb4-2" tabindex="-1"></a>        <span class="ex">~/usearch</span> <span class="at">-distmx_split_identity</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>_distmax.txt <span class="at">-mindist</span> 0.025 <span class="at">-maxdist</span> 0.035 <span class="at">-tabbedout</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>.97.subsets.txt</span>
<span id="cb4-3"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb4-3" tabindex="-1"></a>        <span class="ex">~/usearch</span> <span class="at">-distmx_split_identity</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>_distmax.txt <span class="at">-mindist</span> 0.045 <span class="at">-maxdist</span> 0.055 <span class="at">-tabbedout</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>.95.subsets.txt</span>
<span id="cb4-4"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb4-4" tabindex="-1"></a>        <span class="ex">~/usearch</span> <span class="at">-distmx_split_identity</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>_distmax.txt <span class="at">-mindist</span> 0.095 <span class="at">-maxdist</span> 0.105 <span class="at">-tabbedout</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>.90.subsets.txt</span>
<span id="cb4-5"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb4-5" tabindex="-1"></a><span class="cf">done</span></span></code></pre></div>
<p>Output is a tabbed text given by the -tabbedout option. Fields are:</p>
<ul>
<li>Col1 - <code>Subset name</code> : there are four subsets with names <code>1</code>, <code>2</code>, <code>1x</code> and <code>2x</code>.</li>
<li>Col2 - <code>Label1</code> : label1 is the label of a sequence in the subset given by Col1.</li>
<li>Col3 - <code>Label2</code> : label2 is the top hit in the other subset (1 or 2)</li>
<li>Col4 - <code>Dist</code> : distance between Label1 and Label2.</li>
</ul>
<p>Subsets <code>1</code> and <code>2</code> have top hits to each other in the specified range. Subset <code>1x</code> has lower identities with subset <code>2</code>, and can therefore be added to the training set if subset <code>2</code> is the query set. Similarly, subset <code>2x</code> has lower identities with subset <code>1</code> and can be added to the training set if subset <code>1</code> is the query</p>
<p>Get sequence ID for training and test set.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb5-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.subsets.txt <span class="kw">;</span> <span class="cf">do</span> <span class="fu">awk</span> <span class="st">&#39;$1==1 || $1==&quot;1x&quot; {print $2}&#39;</span> <span class="va">$i</span> <span class="op">&gt;</span> <span class="va">$i</span>.trainingIDs.txt<span class="kw">;</span> <span class="fu">awk</span> <span class="st">&#39;$1==2 {print $2}&#39;</span> <span class="va">$i</span> <span class="op">&gt;</span> <span class="va">$i</span>.testIDs.txt<span class="kw">;</span> <span class="cf">done</span></span></code></pre></div>
<p>Create fasta file with test and training set at each identity, use subset 1 as training and subset 2 as test. If sekqit is installed throught conda activate base environnement first.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb6-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.trainingIDs.txt <span class="kw">;</span> <span class="cf">do</span> <span class="ex">seqkit</span> grep <span class="at">-n</span> <span class="at">-f</span> <span class="va">$i</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>.fasta <span class="op">&gt;</span> <span class="va">$i</span>.trainning.fasta <span class="kw">;</span> <span class="cf">done</span></span>
<span id="cb6-2"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb6-2" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.testIDs.txt <span class="kw">;</span> <span class="cf">do</span> <span class="ex">seqkit</span> grep <span class="at">-n</span> <span class="at">-f</span> <span class="va">$i</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>.fasta <span class="op">&gt;</span> <span class="va">$i</span>.test.fasta <span class="kw">;</span> <span class="cf">done</span> </span></code></pre></div>
<p>Rename files</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb7-1" tabindex="-1"></a><span class="cf">for</span> file <span class="kw">in</span> <span class="pp">*</span>subsets<span class="pp">*</span> <span class="kw">;</span> <span class="cf">do</span> <span class="fu">mv</span> <span class="va">$file</span> <span class="va">${file</span><span class="op">//</span><span class="ss">.9</span><span class="op">/</span>_9<span class="va">}</span> <span class="kw">;</span> <span class="cf">done</span></span></code></pre></div>
</div>
<div id="generate-predictions-for-rdp-classifier" class="section level2 unnumbered hasAnchor">
<h2>Generate predictions for RDP Classifier<a href="taxonomy-cross-validation-by-identity-taxxi.html#generate-predictions-for-rdp-classifier" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Following steps were adapted from John Quensen’s tutorial (<a href="https://john-quensen.com/tutorials/training-the-rdp-classifier/">link</a>) and available <a href="https://github.com/mirand863/hitac/tree/main/benchmark">scripts</a> associated with publication by <a href="https://doi.org/10.1101/2020.04.24.014852">Miranda (2020)</a>.</p>
<div id="required-files" class="section level3 unnumbered hasAnchor">
<h3>Required files<a href="taxonomy-cross-validation-by-identity-taxxi.html#required-files" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>To train the newly generated training set for each identity level you need to generate a sequence file and a taxonomy file, each with special formatting requirements :</p>
<p><strong>Sequence file</strong></p>
<p>The sequence file must be in fasta format and contain a unique identifier without any white space. The accession number makes a good identifier. Anything after the first white space is ignored. The following are acceptable:</p>
<pre><code>&gt;DQ248313
ACGATTTTGACCCTTCGGGGTCGATCTCCAACCCTTCGGGGTCGATCGATTTTGACCCT
&gt;JF735302 k__Fungi;p__Ascomycota;c__Sordariomycetes;o__Hypocreales;f__Nectriaceae;g__Dactylonectria;s__Dactylonectria_anthuriicol
CCGAGTTTTCAACTCGACCCTTCGGGGTCGTCGATCTCCAACCCGATCGATTTTGAACC</code></pre>
<p><strong>Taxonomy file</strong></p>
<p>The taxonomy file is a tab-delimited text file beginning with a header giving the Sequence ID and names of ranks to be included. There are two requirements for this file:</p>
<ul>
<li>There must be an entry for every rank in every line.</li>
<li>Hyphen placeholders are allowed but are not recommended.</li>
<li>“Convergent evolution” is not allowed. For example, the same genus cannot appear in two different families.</li>
<li>Options for missing ranks :</li>
</ul>
<p>If a rank does not exist, you can fill in the missing entries with hyphens but it is not recommended as it can lead to a “ragged” classification that cannot be properly sorted by rank. Another option is to fill in the empty spaces with made-up but meaningful ranks as in the table below. The prefixes indicate the highest rank available. The absence of hyphen placeholders means that classification will not be ragged but include all ranks. Thus it will be possible to select, sort, and merge ranks when analyzing your data later.</p>
<p>Example format :</p>
<table>
<colgroup>
<col width="13%" />
<col width="13%" />
<col width="12%" />
<col width="12%" />
<col width="10%" />
<col width="12%" />
<col width="24%" />
</colgroup>
<thead>
<tr class="header">
<th>Seq_ID</th>
<th>Kingdom</th>
<th>Phylum</th>
<th>Class</th>
<th>Order</th>
<th>Family</th>
<th>Genus Species</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>MG190602</td>
<td>Fungi</td>
<td>Ascomycota</td>
<td>Sordariomycetes</td>
<td>Hypocreales</td>
<td>o_Hypocreales</td>
<td>o_f_Hypocreales</td>
</tr>
<tr class="even">
<td>MF120484</td>
<td>Fungi</td>
<td>Ascomycota</td>
<td>Sordariomycetes</td>
<td>Hypocreales</td>
<td>Nectriaceae</td>
<td>Fusarium</td>
</tr>
</tbody>
</table>
<p><strong>Scripts</strong></p>
<ul>
<li><code>lineage2taxTrain.py</code></li>
<li><code>addFullLineage.py</code></li>
</ul>
</div>
<div id="generate-required-files" class="section level3 unnumbered hasAnchor">
<h3>Generate required files<a href="taxonomy-cross-validation-by-identity-taxxi.html#generate-required-files" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><strong>Taxonomy file</strong></p>
<p>Extract sequence header using grep.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb9-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.trainning.fasta <span class="kw">;</span> <span class="cf">do</span> <span class="fu">grep</span> <span class="at">-e</span> <span class="st">&quot;&gt;&quot;</span> <span class="va">$i</span> <span class="op">&gt;</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>_trainheader.txt <span class="kw">;</span> <span class="cf">done</span> </span></code></pre></div>
<p>Replace semi-colon with tabs and remove “&gt;”.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb10-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.trainingIDs.txt <span class="kw">;</span> <span class="cf">do</span> <span class="fu">sed</span> <span class="st">&#39;s/;/\t/g&#39;</span> <span class="va">$i</span> <span class="op">&gt;</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>.RDP_trainID.txt <span class="kw">;</span> <span class="cf">done</span> </span>
<span id="cb10-2"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb10-2" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.RDP_trainID.txt <span class="kw">;</span> <span class="cf">do</span> <span class="fu">sed</span> <span class="at">-i</span> <span class="st">&#39;s/&gt;//g&#39;</span> <span class="va">$i</span> <span class="kw">;</span> <span class="cf">done</span> </span></code></pre></div>
<p>Add header (rank followed by column number i.e. <code>rank_1</code>, <code>rank_2</code>, etc.).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb11-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.RDP_trainID.txt <span class="kw">;</span> <span class="cf">do</span> <span class="fu">awk</span> <span class="at">-i</span> inplace <span class="st">&#39;BEGIN {OFS=FS=&quot;\t&quot;} NR==1{for (i=1;i&lt;=NF;i++) printf &quot;%s%s&quot;, &quot;rank_&quot;i, i==NF?ORS:OFS}1&#39;</span> <span class="va">$i</span> <span class="kw">;</span> <span class="cf">done</span></span></code></pre></div>
<p>Details :</p>
<ul>
<li>BEGIN {OFS=FS=“} sets the input and output delimiter to tab, instead of the default space. Change” to your delimiter if its not tab.</li>
<li>NR==1{} says to execute the actions only on the first line</li>
</ul>
<p><span style="color:red"> TO DO : Pipe these commands together </span></p>
<p><strong>Sequence file</strong></p>
<p>Replace semi-colon with tabs</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb12-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.trainning.fasta <span class="kw">;</span> <span class="cf">do</span> <span class="fu">sed</span> <span class="at">-i</span> <span class="st">&#39;s/;/\t/g&#39;</span> <span class="va">$i</span> <span class="kw">;</span> <span class="cf">done</span> </span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb13-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.RDP_trainID.txt <span class="kw">;</span> <span class="cf">do</span> <span class="ex">python2</span> lineage2taxTrain.py <span class="va">$i</span> <span class="op">&gt;</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>.ready4train_tax.txt <span class="kw">;</span> <span class="cf">done</span></span>
<span id="cb13-2"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb13-2" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.trainning.fasta <span class="kw">;</span> <span class="cf">do</span> <span class="ex">python2</span> addFullLineage.py <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>.RDP_trainID.txt <span class="va">$i</span> <span class="op">&gt;</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>.ready4train_seqs.fasta <span class="kw">;</span> <span class="cf">done</span> </span></code></pre></div>
</div>
<div id="train-the-set" class="section level3 unnumbered hasAnchor">
<h3>Train the set<a href="taxonomy-cross-validation-by-identity-taxxi.html#train-the-set" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb14-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.ready4train_tax.txt <span class="kw">;</span> <span class="cf">do</span> <span class="ex">java</span> <span class="at">-Xmx10g</span> <span class="at">-jar</span> ~/rdp_classifier_2.14/dist/classifier.jar train <span class="at">-o</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>_training_files <span class="at">-s</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>.ready4train_seqs.fasta <span class="at">-t</span> <span class="va">$i</span> <span class="kw">;</span> <span class="cf">done</span></span></code></pre></div>
<p>Output is a directory specified by the parameter <code>-o</code> which should contain the following files :</p>
<ul>
<li>bergeyTrainingTree.xml</li>
<li>genus_wordConditionalProbList.txt</li>
<li>logWordPrior.txt</li>
<li>wordConditionalProbIndexArr.txt</li>
</ul>
<p>Move into this newly created directory and create the file <code>rRNAClassifier.properties</code> with the following text :</p>
<pre><code># Sample ResourceBundle properties file
bergeyTree=bergeyTrainingTree.xml

probabilityList=genus_wordConditionalProbList.txt

probabilityIndex=wordConditionalProbIndexArr.txt

wordPrior=logWordPrior.txt

classifierVersion=RDP Naive Bayesian rRNA Classifier Version 2.14</code></pre>
</div>
<div id="generate-predictions" class="section level3 unnumbered hasAnchor">
<h3>Generate predictions<a href="taxonomy-cross-validation-by-identity-taxxi.html#generate-predictions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb16-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.ready4train_seqs.fasta <span class="kw">;</span> </span>
<span id="cb16-2"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb16-2" tabindex="-1"></a><span class="cf">do</span>  <span class="ex">java</span> <span class="at">-Xmx1g</span> <span class="at">-jar</span> ~/rdp_classifier_2.14/dist/classifier.jar <span class="at">-q</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>.subsets.txt.testIDs.txt.test.fasta <span class="at">-t</span> ./<span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>_training_files/rRNAClassifier.properties <span class="at">-o</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>.predictions.tsv <span class="kw">;</span> <span class="cf">done</span> </span></code></pre></div>
</div>
</div>
<div id="generate-predictions-for-vsearch" class="section level2 unnumbered hasAnchor">
<h2>Generate predictions for VSEARCH<a href="taxonomy-cross-validation-by-identity-taxxi.html#generate-predictions-for-vsearch" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb17"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="taxonomy-cross-validation-by-identity-taxxi.html#cb17-1" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="pp">*</span>.subsets.txt.testIDs.txt.test.fasta <span class="kw">;</span> <span class="cf">do</span> <span class="ex">vsearch</span> <span class="at">--usearch_global</span> <span class="va">$i</span> <span class="at">-db</span> <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>.subsets.txt.trainingIDs.txt.trainning.fasta <span class="at">--blast6out</span>  <span class="va">${i</span><span class="op">%%</span>.<span class="pp">*</span><span class="va">}</span>.vsearch_prediction.tsv <span class="at">--top_hits_only</span> <span class="at">--id</span> 0.70<span class="kw">;</span> <span class="cf">done</span> </span></code></pre></div>
<p>Output is a tabbed text given by the -blast6out option. Fields are:</p>
<ul>
<li>Col1 : <code>query_name</code></li>
<li>Col2 : <code>target</code></li>
<li>Col3 : <code>id</code></li>
<li>Col4 : <code>alnlen</code></li>
<li>Col5 : <code>mism</code></li>
<li>Col6 : <code>opens</code></li>
<li>Col7 : <code>qlo</code></li>
<li>Col8 : <code>qhi</code></li>
<li>Col9 : <code>tlo</code></li>
<li>Col10 : <code>thi</code></li>
<li>Col11 : <code>evalue</code></li>
<li>Col12 : <code>bits</code></li>
</ul>
</div>
<div id="cvi-metrics" class="section level2 unnumbered hasAnchor">
<h2>CVI metrics<a href="taxonomy-cross-validation-by-identity-taxxi.html#cvi-metrics" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><strong>Important definitions :</strong></p>
<ul>
<li>N : number of sequences in the test set S,</li>
<li>K : number of sequences in S with known names (names which are present in the training set A)</li>
<li>L : number of novel test sequences (= N – K) (sequences in S with names that are not present in A)</li>
<li>TP : number of names which are correctly predicted</li>
<li>MC : number of misclassification errors</li>
<li>OC : number of over-classification errors</li>
<li>UC : number under-classification errors</li>
</ul>
<p>The rate for each type of error is defined as the number of errors divided by the number of opportunities to make that error:</p>
<ul>
<li>OCR = OC/L (over-classification rate),</li>
<li>UCR = UC/K (under-classification rate)</li>
<li>MCR = MC/K (misclassification rate)</li>
<li>TPR = TP/K</li>
<li>Acc = TP/(K + OC)</li>
</ul>
<p>For each rank the mean values of the metrics over all test/training pairs for all values of the top-hit identity (d) was calculated and is designated by prefix <em>Avg</em>.</p>
<ul>
<li><p>True-positive rate (<em>AvgTPR</em>)</p></li>
<li><p>Under-classification errors (<em>AvgUCR</em>)</p></li>
<li><p>Misclassification rate (<em>AvgMCR</em>)</p></li>
<li><p>Over-classification rate (<em>AvgOCR</em>)</p></li>
<li><p>Average L10Acc</p></li>
<li><p>Average accuracy (<em>AvgAcc</em>)</p></li>
<li><p>The <em>lowest common rank</em> (LCR) of two sequences is the lowest rank where both have the same taxon name.</p></li>
<li><p>The <em>most probable lowest common rank</em> (MLR) for a pair of sequences with identity <em>d</em> is defined as the LCR with highest probability. MLRs can be summarized by giving the rank identity threshold (RIT) for each rank <em>r</em>.</p></li>
<li><p>The <em>rank identity threshold</em> (RIT) for each rank <em>r</em> is defined as the minimum identity for which MLR(d) = <em>r</em>. For example, if MLR(100) = species, MLR(99) = genus, MLR(98) = genus, … MLR(94) = genus and MLR(93) = family, then RIT(species) = 100 and RIT(genus) = 94.</p></li>
<li><p>The <em>top-hit identity distribution</em> (THID) is the distances from a reference database.</p></li>
</ul>
<div id="script-to-evaluate-prediction" class="section level3 unnumbered hasAnchor">
<h3>Script to evaluate prediction<a href="taxonomy-cross-validation-by-identity-taxxi.html#script-to-evaluate-prediction" class="anchor-section" aria-label="Anchor link to header"></a></h3>

</div>
</div>
</div>
<hr>
<center>
  <div class="footer">
      Karine Villeneuve
      <p : id="date"></p>
<script>
  // Get current date and time
//  var now = new Date();
//  var date = now.toLocaleString();
//  n =  new Date();
//  y = n.getFullYear();
//  m = n.getMonth();
//  d = n.getDate();
//  document.getElementById("date").innerHTML = d + "/" + m + "/" + y;
  n = new Date().toDateString()
  document.getElementById("date").innerHTML = n
  // Insert date and time into HTML
//  document.getElementById("date").innerHTML = date;
</script>
  </div>
</center>
            </section>

          </div>
        </div>
      </div>
<a href="index.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="required-files-scripts-and-programs.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/karinevilleneuve/fish_eDNA/master/01_taxxi.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
}
});
});
</script>

</body>

</html>
